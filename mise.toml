[tools]
bun = "1.3.0"
pkl = "0.29.1"
go = "1.25.4"

[tasks.format]
description = "Format TypeScript files with oxfmt"
run = "bun run format"

[tasks."format:check"]
description = "Check TypeScript formatting without writing"
run = "bun run format:check"

[tasks.test]
description = "Run tests with Bun"
run = "bun test"

[tasks.typecheck]
description = "Run TypeScript type checking"
run = "bun run typecheck"

[tasks.install]
description = "Install dependencies with Bun"
run = "bun install"

[tasks.actionlint]
description = "Run actionlint"
run = 'docker run --rm -t -v "$PWD":/repo -w /repo rhysd/actionlint:1.7.8 -color'

[tasks."workflows:clear"]
description = "Remove generated GitHub Actions workflows"
run = "rm -r .github/workflows/*.generated.yml"

[tasks."workflows:build"]
description = "Generate GitHub Actions workflows from TypeScript"
run = "bun run .github/build.ts"
sources = [
  ".github/build.ts",
  ".github/**/*.ts",
  "src/**/*.ts",
  ".github/**/*.mjs",
]
outputs = [".github/workflows/*.generated.yml"]

[tasks."scripts:fetch-workflow"]
description = "Fetch GitHub Workflow schema"
outputs = ["scripts/github/github-workflow.json"]
run = "curl -fsSL https://www.schemastore.org/github-workflow.json -o scripts/github/github-workflow.json"

[tasks."scripts:fetch-actionlint"]
description = "Fetch actionlint"
outputs = ["scripts/actionlint/expr_sema.go"]
run = "curl -fsSL https://raw.githubusercontent.com/rhysd/actionlint/refs/heads/main/expr_sema.go -o scripts/actionlint/expr_sema.go"

[tasks."scripts:extract-context"]
description = "Run the extract-context Go helper"
tools.go = "1.25.4"
# depends = ["scripts:fetch-actionlint"]
sources = ["scripts/actionlint/expr_sema.go", "scripts/extract-context.go"]
outputs = [
  "scripts/actionlint/builtin-global-variable-types.json",
  "scripts/actionlint/builtin-func-signatures.json",
]
run = "go run scripts/extract-context.go"

[tasks."scripts:generate-events"]
description = "Generate types for github.event from @octokit/webhooks-types (dev-time only)"
tools.bun = "1.3.0"
env = { WEBHOOKS_TYPES_VERSION = "latest" }
sources = ["scripts/generate-events.ts"]
outputs = ["src/events-generated.ts"]
run = "bun run scripts/generate-events.ts"

[tasks."scripts:generate-context"]
description = "Generate TypeScript context and functions from actionlint JSON"
tools.bun = "1.3.0"
# depends = ["scripts:extract-context"]
sources = [
  "scripts/generate-context.ts",
  "scripts/actionlint/builtin-global-variable-types.json",
  "scripts/actionlint/builtin-func-signatures.json",
  "src/expr-core.ts",
]
outputs = ["src/context-generated.ts"]
run = "bun run scripts/generate-context.ts"

[tasks."oc:colima"]
description = "Start Colima"
tools.lima = "1.2.1"
tools.colima = "0.9.1"
run = "colima start"

[tasks."oc:colima:stop"]
description = "Stop Colima"
tools.lima = "1.2.1"
tools.colima = "0.9.1"
run = "colima stop"

[tasks.oc]
run = "docker run --rm -it -v $PWD:/work -w /work -v ~/.colima-jail/mise:/mise -v ~/.colima-jail/root:/root jdxcode/mise:latest run opencode"

[tasks.opencode]
tools.opencode = "latest"
run = "opencode"

[tasks."clone-to-npm:ci"]
description = "Clone to npm (CI)"
tools.bun = "1.3.0"
run = "mise run clone-to-npm"

[tasks."bump-version"]
description = "Bump version"
tools.bun = "1.3.0"
run = '''
#!/usr/bin/env bun
import { $ } from "bun";

const tmpFolder = (await $`mktemp -d`.text()).trim();
await $`cp jsr.json ${tmpFolder}/package.json`;
await $`bun pm pkg get version`.cwd(tmpFolder);
await $`bun pm version patch --no-git-tag-version`.cwd(tmpFolder);
const newVersion = (await $`bun pm pkg get version`.cwd(tmpFolder).text()).trim();
await $`cp ${tmpFolder}/package.json jsr.json`;
await $`rm -rf ${tmpFolder}`;
await $`git commit jsr.json -m "Bump version to ${newVersion}"`;
console.log('Now you can run `git push origin main` to publish the new version');
'''
