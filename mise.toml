[tools]
bun = "1.3.0"
pkl = "0.29.1"

[tasks.format]
description = "Format TypeScript files with oxfmt"
run = "bun run format"

[tasks."format:check"]
description = "Check TypeScript formatting without writing"
run = "bun run format:check"

[tasks.test]
description = "Run tests with Bun"
run = "bun test"

[tasks.typecheck]
description = "Run TypeScript type checking"
run = "bun run typecheck"

[tasks.install]
description = "Install dependencies with Bun"
run = "bun install"

[tasks.actionlint]
description = "Run actionlint"
run = 'docker run --rm -t -v "$PWD":/repo -w /repo rhysd/actionlint:1.7.8 -color'

[tasks."workflows:clear"]
description = "Remove generated GitHub Actions workflows"
run = "rm -r .github/workflows/*.generated.yml"

[tasks."workflows:build"]
description = "Generate GitHub Actions workflows from TypeScript"
run = "bun run .github/build.ts"
sources = [".github/build.ts", ".github/**/*.ts", "src/**/*.ts"]
outputs = [".github/workflows/*.generated.yml"]

[tasks."oc:colima"]
description = "Start Colima"
tools.lima = "1.2.1"
tools.colima = "0.9.1"
run = "colima start"

[tasks."oc:colima:stop"]
description = "Stop Colima"
tools.lima = "1.2.1"
tools.colima = "0.9.1"
run = "colima stop"

[tasks.oc]
run = "docker run --rm -it -v $PWD:/work -w /work -v ~/.colima-jail/mise:/mise -v ~/.colima-jail/root:/root jdxcode/mise:latest run opencode"

[tasks.opencode]
tools.opencode = "latest"
run = "opencode"

[tasks."clone-to-npm:ci"]
description = "Clone to npm (CI)"
tools.bun = "1.3.0"
run = "mise run clone-to-npm"

[tasks."bump-version"]
description = "Bump version"
tools.bun = "1.3.0"
run = '''
#!/usr/bin/env bun
import { $ } from "bun";

const tmpFolder = (await $`mktemp -d`.text()).trim();
await $`cp jsr.json ${tmpFolder}/package.json`;
await $`bun pm pkg get version`.cwd(tmpFolder);
await $`bun pm version patch --no-git-tag-version`.cwd(tmpFolder);
const newVersion = (await $`bun pm pkg get version`.cwd(tmpFolder).text()).trim();
await $`cp ${tmpFolder}/package.json jsr.json`;
await $`rm -rf ${tmpFolder}`;
await $`git commit jsr.json -m "Bump version to ${newVersion}"`;
console.log('Now you can run `git push origin main` to publish the new version');
'''
